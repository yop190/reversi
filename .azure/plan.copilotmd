# Azure Deployment Plan for Reversi

## Goal
Deploy the Reversi Angular application to Azure Container Apps using GitHub Actions CI/CD with Azure CLI commands.

## Project Information

| Attribute | Value |
|-----------|-------|
| **App Name** | reversi |
| **Technology Stack** | Angular 19 + Nginx |
| **Application Type** | Single-page Application (SPA) game |
| **Containerization** | Dockerfile with multi-stage build |
| **Dependencies** | None (stateless, frontend-only) |
| **Hosting** | Azure Container Apps (Consumption) |

## Azure Resources Architecture

```mermaid
graph TB
    subgraph Internet
        User[User Browser]
    end
    
    subgraph Azure["Azure (westeurope)"]
        subgraph RG["Resource Group: rg-reversi-prod"]
            DNS[Custom Domain<br>reversi.lebrere.fr]
            
            subgraph CAE["Container Apps Environment: cae-reversi-prod"]
                CA[Container App: ca-reversi<br>1-10 replicas]
            end
            
            ACR[Container Registry<br>acrreversiprod]
        end
    end
    
    subgraph GitHub
        GHA[GitHub Actions]
    end
    
    User -->|HTTPS| DNS
    DNS -->|Route| CA
    GHA -->|Push Image| ACR
    ACR -->|Pull Image| CA
```

## Data Flow

1. GitHub Actions builds and pushes Docker image to Azure Container Registry
2. Container App pulls the image from ACR on deployment
3. Users access the application via custom domain (reversi.lebrere.fr)
4. Azure provides automatic HTTPS termination with managed certificates
5. Built-in load balancer distributes traffic across replicas

## Recommended Azure Resources

### Application: reversi

| Property | Value |
|----------|-------|
| **Hosting Service** | Azure Container Apps |
| **SKU** | Consumption (pay-per-use) |
| **vCPU** | 0.25 |
| **Memory** | 0.5 Gi |
| **Min Replicas** | 1 |
| **Max Replicas** | 10 |

**Configuration:**
- Language: Node.js 20 / Nginx
- Dockerfile: `./Dockerfile`
- Docker Context: `.`
- Target Port: 80
- Ingress: External
- Environment Variables: None required

### Supporting Services

| Resource | SKU | Purpose |
|----------|-----|---------|
| Container Registry | Basic | Store Docker images |
| Container Apps Environment | Consumption | Host container apps |
| Managed Certificate | Free | HTTPS for custom domain |

### Security Configuration

| Security Control | Implementation |
|-----------------|----------------|
| Authentication | Azure Service Principal (GitHub Actions) |
| Secrets Storage | GitHub Secrets |
| HTTPS | Enforced (Azure-managed certificate) |
| Container Access | ACR admin credentials (stored in GitHub Secrets) |

## Cost Analysis

| Resource | Estimated Monthly Cost |
|----------|----------------------|
| Container Apps (Consumption) | ~$0-5 (idle: free, usage: pay-per-request) |
| Container Registry (Basic) | ~$5 |
| Managed Certificate | Free |
| **Total** | **~$5-10/month** |

*Note: Container Apps Consumption tier only charges for actual usage. Idle containers are free after the free grant.*

## Why Azure Container Apps?

| Requirement | Azure Container Apps |
|-------------|---------------------|
| Stateless workloads | ✅ Native support |
| Automatic HTTPS | ✅ Managed certificates |
| Built-in load balancing | ✅ Included |
| Horizontal scaling | ✅ 0-10+ replicas |
| Cost efficiency | ✅ Consumption tier (cheapest auto-scaling) |
| Serverless | ✅ No infrastructure to manage |

**Rejected Alternatives:**
- **App Service Free (F1)**: No horizontal scaling
- **AKS**: Overkill for single app, higher cost/complexity
- **App Service Premium**: Significantly higher cost
- **Azure Front Door**: Not needed for single-region deployment

## Execution Steps

### 1. Prerequisites

```bash
# GitHub Secrets Required:
# AZURE_CREDENTIALS - Service Principal JSON
```

### 2. Create Service Principal

```bash
# Create Service Principal with Contributor access
az ad sp create-for-rbac \
  --name "sp-reversi-github" \
  --role contributor \
  --scopes /subscriptions/{subscription-id} \
  --sdk-auth
```

Save the output as `AZURE_CREDENTIALS` GitHub Secret.

### 3. Configure DNS

Add CNAME record:
```
reversi.lebrere.fr -> <container-app-fqdn>
```

### 4. Push to GitHub

```bash
git remote add origin https://github.com/<username>/reversi.git
git push -u origin main
```

The GitHub Actions workflow will automatically:
1. Build and test the application
2. Create Azure infrastructure (idempotent)
3. Build and push Docker image
4. Deploy to Container Apps
5. Configure custom domain and SSL
6. Verify deployment health

## Validation

After deployment, verify:

1. **Health Endpoint**: `curl https://reversi.lebrere.fr/health`
   - Expected: HTTP 200 with JSON body

2. **Main Application**: `curl https://reversi.lebrere.fr/`
   - Expected: HTTP 200 with HTML content

3. **TLS Certificate**: Valid and issued by Azure
